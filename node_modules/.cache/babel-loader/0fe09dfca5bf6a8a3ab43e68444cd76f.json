{"ast":null,"code":"import _classCallCheck from \"/Users/theodaguier/_workdir/dev/pro/e-do/E-Do-Studio/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/theodaguier/_workdir/dev/pro/e-do/E-Do-Studio/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _inherits from \"/Users/theodaguier/_workdir/dev/pro/e-do/E-Do-Studio/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _createSuper from \"/Users/theodaguier/_workdir/dev/pro/e-do/E-Do-Studio/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";\nimport { Loader, FileLoader, Vector3, Matrix4 } from \"three\";\nimport { gunzipSync } from \"fflate\";\nimport { Volume } from \"../misc/Volume.js\";\n\nvar NRRDLoader = /*#__PURE__*/function (_Loader) {\n  _inherits(NRRDLoader, _Loader);\n\n  var _super = _createSuper(NRRDLoader);\n\n  function NRRDLoader(manager) {\n    _classCallCheck(this, NRRDLoader);\n\n    return _super.call(this, manager);\n  }\n\n  _createClass(NRRDLoader, [{\n    key: \"load\",\n    value: function load(url, onLoad, onProgress, onError) {\n      var scope = this;\n      var loader = new FileLoader(scope.manager);\n      loader.setPath(scope.path);\n      loader.setResponseType(\"arraybuffer\");\n      loader.setRequestHeader(scope.requestHeader);\n      loader.setWithCredentials(scope.withCredentials);\n      loader.load(url, function (data) {\n        try {\n          onLoad(scope.parse(data));\n        } catch (e) {\n          if (onError) {\n            onError(e);\n          } else {\n            console.error(e);\n          }\n\n          scope.manager.itemError(url);\n        }\n      }, onProgress, onError);\n    }\n  }, {\n    key: \"parse\",\n    value: function parse(data) {\n      var _data = data;\n      var _dataPointer = 0;\n\n      var _nativeLittleEndian = new Int8Array(new Int16Array([1]).buffer)[0] > 0;\n\n      var _littleEndian = true;\n      var headerObject = {};\n\n      function scan(type, chunks) {\n        if (chunks === void 0 || chunks === null) {\n          chunks = 1;\n        }\n\n        var _chunkSize = 1;\n        var _array_type = Uint8Array;\n\n        switch (type) {\n          case \"uchar\":\n            break;\n\n          case \"schar\":\n            _array_type = Int8Array;\n            break;\n\n          case \"ushort\":\n            _array_type = Uint16Array;\n            _chunkSize = 2;\n            break;\n\n          case \"sshort\":\n            _array_type = Int16Array;\n            _chunkSize = 2;\n            break;\n\n          case \"uint\":\n            _array_type = Uint32Array;\n            _chunkSize = 4;\n            break;\n\n          case \"sint\":\n            _array_type = Int32Array;\n            _chunkSize = 4;\n            break;\n\n          case \"float\":\n            _array_type = Float32Array;\n            _chunkSize = 4;\n            break;\n\n          case \"complex\":\n            _array_type = Float64Array;\n            _chunkSize = 8;\n            break;\n\n          case \"double\":\n            _array_type = Float64Array;\n            _chunkSize = 8;\n            break;\n        }\n\n        var _bytes2 = new _array_type(_data.slice(_dataPointer, _dataPointer += chunks * _chunkSize));\n\n        if (_nativeLittleEndian != _littleEndian) {\n          _bytes2 = flipEndianness(_bytes2, _chunkSize);\n        }\n\n        if (chunks == 1) {\n          return _bytes2[0];\n        }\n\n        return _bytes2;\n      }\n\n      function flipEndianness(array, chunkSize) {\n        var u8 = new Uint8Array(array.buffer, array.byteOffset, array.byteLength);\n\n        for (var i2 = 0; i2 < array.byteLength; i2 += chunkSize) {\n          for (var j = i2 + chunkSize - 1, k = i2; j > k; j--, k++) {\n            var tmp = u8[k];\n            u8[k] = u8[j];\n            u8[j] = tmp;\n          }\n        }\n\n        return array;\n      }\n\n      function parseHeader(header) {\n        var data2, field, fn, i2, l, m, _i, _len;\n\n        var lines = header.split(/\\r?\\n/);\n\n        for (_i = 0, _len = lines.length; _i < _len; _i++) {\n          l = lines[_i];\n\n          if (l.match(/NRRD\\d+/)) {\n            headerObject.isNrrd = true;\n          } else if (l.match(/^#/)) {} else if (m = l.match(/(.*):(.*)/)) {\n            field = m[1].trim();\n            data2 = m[2].trim();\n            fn = _fieldFunctions[field];\n\n            if (fn) {\n              fn.call(headerObject, data2);\n            } else {\n              headerObject[field] = data2;\n            }\n          }\n        }\n\n        if (!headerObject.isNrrd) {\n          throw new Error(\"Not an NRRD file\");\n        }\n\n        if (headerObject.encoding === \"bz2\" || headerObject.encoding === \"bzip2\") {\n          throw new Error(\"Bzip is not supported\");\n        }\n\n        if (!headerObject.vectors) {\n          headerObject.vectors = [new Vector3(1, 0, 0), new Vector3(0, 1, 0), new Vector3(0, 0, 1)];\n\n          if (headerObject.spacings) {\n            for (i2 = 0; i2 <= 2; i2++) {\n              if (!isNaN(headerObject.spacings[i2])) {\n                headerObject.vectors[i2].multiplyScalar(headerObject.spacings[i2]);\n              }\n            }\n          }\n        }\n      }\n\n      function parseDataAsText(data2, start, end) {\n        var number = \"\";\n        start = start || 0;\n        end = end || data2.length;\n        var value;\n        var lengthOfTheResult = headerObject.sizes.reduce(function (previous, current) {\n          return previous * current;\n        }, 1);\n        var base = 10;\n\n        if (headerObject.encoding === \"hex\") {\n          base = 16;\n        }\n\n        var result = new headerObject.__array(lengthOfTheResult);\n        var resultIndex = 0;\n        var parsingFunction = parseInt;\n\n        if (headerObject.__array === Float32Array || headerObject.__array === Float64Array) {\n          parsingFunction = parseFloat;\n        }\n\n        for (var i2 = start; i2 < end; i2++) {\n          value = data2[i2];\n\n          if ((value < 9 || value > 13) && value !== 32) {\n            number += String.fromCharCode(value);\n          } else {\n            if (number !== \"\") {\n              result[resultIndex] = parsingFunction(number, base);\n              resultIndex++;\n            }\n\n            number = \"\";\n          }\n        }\n\n        if (number !== \"\") {\n          result[resultIndex] = parsingFunction(number, base);\n          resultIndex++;\n        }\n\n        return result;\n      }\n\n      var _bytes = scan(\"uchar\", data.byteLength);\n\n      var _length = _bytes.length;\n      var _header = null;\n      var _data_start = 0;\n      var i;\n\n      for (i = 1; i < _length; i++) {\n        if (_bytes[i - 1] == 10 && _bytes[i] == 10) {\n          _header = this.parseChars(_bytes, 0, i - 2);\n          _data_start = i + 1;\n          break;\n        }\n      }\n\n      parseHeader(_header);\n      _data = _bytes.subarray(_data_start);\n\n      if (headerObject.encoding.substring(0, 2) === \"gz\") {\n        _data = gunzipSync(new Uint8Array(_data));\n      } else if (headerObject.encoding === \"ascii\" || headerObject.encoding === \"text\" || headerObject.encoding === \"txt\" || headerObject.encoding === \"hex\") {\n        _data = parseDataAsText(_data);\n      } else if (headerObject.encoding === \"raw\") {\n        var _copy = new Uint8Array(_data.length);\n\n        for (var i2 = 0; i2 < _data.length; i2++) {\n          _copy[i2] = _data[i2];\n        }\n\n        _data = _copy;\n      }\n\n      _data = _data.buffer;\n      var volume = new Volume();\n      volume.header = headerObject;\n      volume.data = new headerObject.__array(_data);\n      var min_max = volume.computeMinMax();\n      var min = min_max[0];\n      var max = min_max[1];\n      volume.windowLow = min;\n      volume.windowHigh = max;\n      volume.dimensions = [headerObject.sizes[0], headerObject.sizes[1], headerObject.sizes[2]];\n      volume.xLength = volume.dimensions[0];\n      volume.yLength = volume.dimensions[1];\n      volume.zLength = volume.dimensions[2];\n      var spacingX = new Vector3(headerObject.vectors[0][0], headerObject.vectors[0][1], headerObject.vectors[0][2]).length();\n      var spacingY = new Vector3(headerObject.vectors[1][0], headerObject.vectors[1][1], headerObject.vectors[1][2]).length();\n      var spacingZ = new Vector3(headerObject.vectors[2][0], headerObject.vectors[2][1], headerObject.vectors[2][2]).length();\n      volume.spacing = [spacingX, spacingY, spacingZ];\n      volume.matrix = new Matrix4();\n      var _spaceX = 1;\n      var _spaceY = 1;\n      var _spaceZ = 1;\n\n      if (headerObject.space == \"left-posterior-superior\") {\n        _spaceX = -1;\n        _spaceY = -1;\n      } else if (headerObject.space === \"left-anterior-superior\") {\n        _spaceX = -1;\n      }\n\n      if (!headerObject.vectors) {\n        volume.matrix.set(_spaceX, 0, 0, 0, 0, _spaceY, 0, 0, 0, 0, _spaceZ, 0, 0, 0, 0, 1);\n      } else {\n        var v = headerObject.vectors;\n        volume.matrix.set(_spaceX * v[0][0], _spaceX * v[1][0], _spaceX * v[2][0], 0, _spaceY * v[0][1], _spaceY * v[1][1], _spaceY * v[2][1], 0, _spaceZ * v[0][2], _spaceZ * v[1][2], _spaceZ * v[2][2], 0, 0, 0, 0, 1);\n      }\n\n      volume.inverseMatrix = new Matrix4();\n      volume.inverseMatrix.copy(volume.matrix).invert();\n      volume.RASDimensions = new Vector3(volume.xLength, volume.yLength, volume.zLength).applyMatrix4(volume.matrix).round().toArray().map(Math.abs);\n\n      if (volume.lowerThreshold === -Infinity) {\n        volume.lowerThreshold = min;\n      }\n\n      if (volume.upperThreshold === Infinity) {\n        volume.upperThreshold = max;\n      }\n\n      return volume;\n    }\n  }, {\n    key: \"parseChars\",\n    value: function parseChars(array, start, end) {\n      if (start === void 0) {\n        start = 0;\n      }\n\n      if (end === void 0) {\n        end = array.length;\n      }\n\n      var output = \"\";\n      var i = 0;\n\n      for (i = start; i < end; ++i) {\n        output += String.fromCharCode(array[i]);\n      }\n\n      return output;\n    }\n  }]);\n\n  return NRRDLoader;\n}(Loader);\n\nvar _fieldFunctions = {\n  type: function type(data) {\n    switch (data) {\n      case \"uchar\":\n      case \"unsigned char\":\n      case \"uint8\":\n      case \"uint8_t\":\n        this.__array = Uint8Array;\n        break;\n\n      case \"signed char\":\n      case \"int8\":\n      case \"int8_t\":\n        this.__array = Int8Array;\n        break;\n\n      case \"short\":\n      case \"short int\":\n      case \"signed short\":\n      case \"signed short int\":\n      case \"int16\":\n      case \"int16_t\":\n        this.__array = Int16Array;\n        break;\n\n      case \"ushort\":\n      case \"unsigned short\":\n      case \"unsigned short int\":\n      case \"uint16\":\n      case \"uint16_t\":\n        this.__array = Uint16Array;\n        break;\n\n      case \"int\":\n      case \"signed int\":\n      case \"int32\":\n      case \"int32_t\":\n        this.__array = Int32Array;\n        break;\n\n      case \"uint\":\n      case \"unsigned int\":\n      case \"uint32\":\n      case \"uint32_t\":\n        this.__array = Uint32Array;\n        break;\n\n      case \"float\":\n        this.__array = Float32Array;\n        break;\n\n      case \"double\":\n        this.__array = Float64Array;\n        break;\n\n      default:\n        throw new Error(\"Unsupported NRRD data type: \" + data);\n    }\n\n    return this.type = data;\n  },\n  endian: function endian(data) {\n    return this.endian = data;\n  },\n  encoding: function encoding(data) {\n    return this.encoding = data;\n  },\n  dimension: function dimension(data) {\n    return this.dim = parseInt(data, 10);\n  },\n  sizes: function sizes(data) {\n    var i;\n    return this.sizes = function () {\n      var _ref = data.split(/\\s+/);\n\n      var _results = [];\n\n      for (var _i = 0, _len = _ref.length; _i < _len; _i++) {\n        i = _ref[_i];\n\n        _results.push(parseInt(i, 10));\n      }\n\n      return _results;\n    }();\n  },\n  space: function space(data) {\n    return this.space = data;\n  },\n  \"space origin\": function spaceOrigin(data) {\n    return this.space_origin = data.split(\"(\")[1].split(\")\")[0].split(\",\");\n  },\n  \"space directions\": function spaceDirections(data) {\n    var f, v;\n    var parts = data.match(/\\(.*?\\)/g);\n    return this.vectors = function () {\n      var _results = [];\n\n      for (var _i = 0, _len = parts.length; _i < _len; _i++) {\n        v = parts[_i];\n\n        _results.push(function () {\n          var _ref = v.slice(1, -1).split(/,/);\n\n          var _results2 = [];\n\n          for (var _j = 0, _len2 = _ref.length; _j < _len2; _j++) {\n            f = _ref[_j];\n\n            _results2.push(parseFloat(f));\n          }\n\n          return _results2;\n        }());\n      }\n\n      return _results;\n    }();\n  },\n  spacings: function spacings(data) {\n    var f;\n    var parts = data.split(/\\s+/);\n    return this.spacings = function () {\n      var _results = [];\n\n      for (var _i = 0, _len = parts.length; _i < _len; _i++) {\n        f = parts[_i];\n\n        _results.push(parseFloat(f));\n      }\n\n      return _results;\n    }();\n  }\n};\nexport { NRRDLoader };","map":{"version":3,"sources":["/Users/theodaguier/_workdir/dev/pro/e-do/E-Do-Studio/node_modules/three-stdlib/loaders/NRRDLoader.js"],"names":["Loader","FileLoader","Vector3","Matrix4","gunzipSync","Volume","NRRDLoader","manager","url","onLoad","onProgress","onError","scope","loader","setPath","path","setResponseType","setRequestHeader","requestHeader","setWithCredentials","withCredentials","load","data","parse","e","console","error","itemError","_data","_dataPointer","_nativeLittleEndian","Int8Array","Int16Array","buffer","_littleEndian","headerObject","scan","type","chunks","_chunkSize","_array_type","Uint8Array","Uint16Array","Uint32Array","Int32Array","Float32Array","Float64Array","_bytes2","slice","flipEndianness","array","chunkSize","u8","byteOffset","byteLength","i2","j","k","tmp","parseHeader","header","data2","field","fn","l","m","_i","_len","lines","split","length","match","isNrrd","trim","_fieldFunctions","call","Error","encoding","vectors","spacings","isNaN","multiplyScalar","parseDataAsText","start","end","number","value","lengthOfTheResult","sizes","reduce","previous","current","base","result","__array","resultIndex","parsingFunction","parseInt","parseFloat","String","fromCharCode","_bytes","_length","_header","_data_start","i","parseChars","subarray","substring","_copy","volume","min_max","computeMinMax","min","max","windowLow","windowHigh","dimensions","xLength","yLength","zLength","spacingX","spacingY","spacingZ","spacing","matrix","_spaceX","_spaceY","_spaceZ","space","set","v","inverseMatrix","copy","invert","RASDimensions","applyMatrix4","round","toArray","map","Math","abs","lowerThreshold","Infinity","upperThreshold","output","endian","dimension","dim","_ref","_results","push","space_origin","f","parts","_results2","_j","_len2"],"mappings":"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","sourcesContent":["import { Loader, FileLoader, Vector3, Matrix4 } from \"three\";\nimport { gunzipSync } from \"fflate\";\nimport { Volume } from \"../misc/Volume.js\";\nclass NRRDLoader extends Loader {\n  constructor(manager) {\n    super(manager);\n  }\n  load(url, onLoad, onProgress, onError) {\n    const scope = this;\n    const loader = new FileLoader(scope.manager);\n    loader.setPath(scope.path);\n    loader.setResponseType(\"arraybuffer\");\n    loader.setRequestHeader(scope.requestHeader);\n    loader.setWithCredentials(scope.withCredentials);\n    loader.load(\n      url,\n      function(data) {\n        try {\n          onLoad(scope.parse(data));\n        } catch (e) {\n          if (onError) {\n            onError(e);\n          } else {\n            console.error(e);\n          }\n          scope.manager.itemError(url);\n        }\n      },\n      onProgress,\n      onError\n    );\n  }\n  parse(data) {\n    let _data = data;\n    let _dataPointer = 0;\n    const _nativeLittleEndian = new Int8Array(new Int16Array([1]).buffer)[0] > 0;\n    const _littleEndian = true;\n    const headerObject = {};\n    function scan(type, chunks) {\n      if (chunks === void 0 || chunks === null) {\n        chunks = 1;\n      }\n      let _chunkSize = 1;\n      let _array_type = Uint8Array;\n      switch (type) {\n        case \"uchar\":\n          break;\n        case \"schar\":\n          _array_type = Int8Array;\n          break;\n        case \"ushort\":\n          _array_type = Uint16Array;\n          _chunkSize = 2;\n          break;\n        case \"sshort\":\n          _array_type = Int16Array;\n          _chunkSize = 2;\n          break;\n        case \"uint\":\n          _array_type = Uint32Array;\n          _chunkSize = 4;\n          break;\n        case \"sint\":\n          _array_type = Int32Array;\n          _chunkSize = 4;\n          break;\n        case \"float\":\n          _array_type = Float32Array;\n          _chunkSize = 4;\n          break;\n        case \"complex\":\n          _array_type = Float64Array;\n          _chunkSize = 8;\n          break;\n        case \"double\":\n          _array_type = Float64Array;\n          _chunkSize = 8;\n          break;\n      }\n      let _bytes2 = new _array_type(_data.slice(_dataPointer, _dataPointer += chunks * _chunkSize));\n      if (_nativeLittleEndian != _littleEndian) {\n        _bytes2 = flipEndianness(_bytes2, _chunkSize);\n      }\n      if (chunks == 1) {\n        return _bytes2[0];\n      }\n      return _bytes2;\n    }\n    function flipEndianness(array, chunkSize) {\n      const u8 = new Uint8Array(array.buffer, array.byteOffset, array.byteLength);\n      for (let i2 = 0; i2 < array.byteLength; i2 += chunkSize) {\n        for (let j = i2 + chunkSize - 1, k = i2; j > k; j--, k++) {\n          const tmp = u8[k];\n          u8[k] = u8[j];\n          u8[j] = tmp;\n        }\n      }\n      return array;\n    }\n    function parseHeader(header) {\n      let data2, field, fn, i2, l, m, _i, _len;\n      const lines = header.split(/\\r?\\n/);\n      for (_i = 0, _len = lines.length; _i < _len; _i++) {\n        l = lines[_i];\n        if (l.match(/NRRD\\d+/)) {\n          headerObject.isNrrd = true;\n        } else if (l.match(/^#/)) {\n        } else if (m = l.match(/(.*):(.*)/)) {\n          field = m[1].trim();\n          data2 = m[2].trim();\n          fn = _fieldFunctions[field];\n          if (fn) {\n            fn.call(headerObject, data2);\n          } else {\n            headerObject[field] = data2;\n          }\n        }\n      }\n      if (!headerObject.isNrrd) {\n        throw new Error(\"Not an NRRD file\");\n      }\n      if (headerObject.encoding === \"bz2\" || headerObject.encoding === \"bzip2\") {\n        throw new Error(\"Bzip is not supported\");\n      }\n      if (!headerObject.vectors) {\n        headerObject.vectors = [new Vector3(1, 0, 0), new Vector3(0, 1, 0), new Vector3(0, 0, 1)];\n        if (headerObject.spacings) {\n          for (i2 = 0; i2 <= 2; i2++) {\n            if (!isNaN(headerObject.spacings[i2])) {\n              headerObject.vectors[i2].multiplyScalar(headerObject.spacings[i2]);\n            }\n          }\n        }\n      }\n    }\n    function parseDataAsText(data2, start, end) {\n      let number = \"\";\n      start = start || 0;\n      end = end || data2.length;\n      let value;\n      const lengthOfTheResult = headerObject.sizes.reduce(function(previous, current) {\n        return previous * current;\n      }, 1);\n      let base = 10;\n      if (headerObject.encoding === \"hex\") {\n        base = 16;\n      }\n      const result = new headerObject.__array(lengthOfTheResult);\n      let resultIndex = 0;\n      let parsingFunction = parseInt;\n      if (headerObject.__array === Float32Array || headerObject.__array === Float64Array) {\n        parsingFunction = parseFloat;\n      }\n      for (let i2 = start; i2 < end; i2++) {\n        value = data2[i2];\n        if ((value < 9 || value > 13) && value !== 32) {\n          number += String.fromCharCode(value);\n        } else {\n          if (number !== \"\") {\n            result[resultIndex] = parsingFunction(number, base);\n            resultIndex++;\n          }\n          number = \"\";\n        }\n      }\n      if (number !== \"\") {\n        result[resultIndex] = parsingFunction(number, base);\n        resultIndex++;\n      }\n      return result;\n    }\n    const _bytes = scan(\"uchar\", data.byteLength);\n    const _length = _bytes.length;\n    let _header = null;\n    let _data_start = 0;\n    let i;\n    for (i = 1; i < _length; i++) {\n      if (_bytes[i - 1] == 10 && _bytes[i] == 10) {\n        _header = this.parseChars(_bytes, 0, i - 2);\n        _data_start = i + 1;\n        break;\n      }\n    }\n    parseHeader(_header);\n    _data = _bytes.subarray(_data_start);\n    if (headerObject.encoding.substring(0, 2) === \"gz\") {\n      _data = gunzipSync(new Uint8Array(_data));\n    } else if (headerObject.encoding === \"ascii\" || headerObject.encoding === \"text\" || headerObject.encoding === \"txt\" || headerObject.encoding === \"hex\") {\n      _data = parseDataAsText(_data);\n    } else if (headerObject.encoding === \"raw\") {\n      const _copy = new Uint8Array(_data.length);\n      for (let i2 = 0; i2 < _data.length; i2++) {\n        _copy[i2] = _data[i2];\n      }\n      _data = _copy;\n    }\n    _data = _data.buffer;\n    const volume = new Volume();\n    volume.header = headerObject;\n    volume.data = new headerObject.__array(_data);\n    const min_max = volume.computeMinMax();\n    const min = min_max[0];\n    const max = min_max[1];\n    volume.windowLow = min;\n    volume.windowHigh = max;\n    volume.dimensions = [headerObject.sizes[0], headerObject.sizes[1], headerObject.sizes[2]];\n    volume.xLength = volume.dimensions[0];\n    volume.yLength = volume.dimensions[1];\n    volume.zLength = volume.dimensions[2];\n    const spacingX = new Vector3(\n      headerObject.vectors[0][0],\n      headerObject.vectors[0][1],\n      headerObject.vectors[0][2]\n    ).length();\n    const spacingY = new Vector3(\n      headerObject.vectors[1][0],\n      headerObject.vectors[1][1],\n      headerObject.vectors[1][2]\n    ).length();\n    const spacingZ = new Vector3(\n      headerObject.vectors[2][0],\n      headerObject.vectors[2][1],\n      headerObject.vectors[2][2]\n    ).length();\n    volume.spacing = [spacingX, spacingY, spacingZ];\n    volume.matrix = new Matrix4();\n    let _spaceX = 1;\n    let _spaceY = 1;\n    const _spaceZ = 1;\n    if (headerObject.space == \"left-posterior-superior\") {\n      _spaceX = -1;\n      _spaceY = -1;\n    } else if (headerObject.space === \"left-anterior-superior\") {\n      _spaceX = -1;\n    }\n    if (!headerObject.vectors) {\n      volume.matrix.set(_spaceX, 0, 0, 0, 0, _spaceY, 0, 0, 0, 0, _spaceZ, 0, 0, 0, 0, 1);\n    } else {\n      const v = headerObject.vectors;\n      volume.matrix.set(\n        _spaceX * v[0][0],\n        _spaceX * v[1][0],\n        _spaceX * v[2][0],\n        0,\n        _spaceY * v[0][1],\n        _spaceY * v[1][1],\n        _spaceY * v[2][1],\n        0,\n        _spaceZ * v[0][2],\n        _spaceZ * v[1][2],\n        _spaceZ * v[2][2],\n        0,\n        0,\n        0,\n        0,\n        1\n      );\n    }\n    volume.inverseMatrix = new Matrix4();\n    volume.inverseMatrix.copy(volume.matrix).invert();\n    volume.RASDimensions = new Vector3(volume.xLength, volume.yLength, volume.zLength).applyMatrix4(volume.matrix).round().toArray().map(Math.abs);\n    if (volume.lowerThreshold === -Infinity) {\n      volume.lowerThreshold = min;\n    }\n    if (volume.upperThreshold === Infinity) {\n      volume.upperThreshold = max;\n    }\n    return volume;\n  }\n  parseChars(array, start, end) {\n    if (start === void 0) {\n      start = 0;\n    }\n    if (end === void 0) {\n      end = array.length;\n    }\n    let output = \"\";\n    let i = 0;\n    for (i = start; i < end; ++i) {\n      output += String.fromCharCode(array[i]);\n    }\n    return output;\n  }\n}\nconst _fieldFunctions = {\n  type: function(data) {\n    switch (data) {\n      case \"uchar\":\n      case \"unsigned char\":\n      case \"uint8\":\n      case \"uint8_t\":\n        this.__array = Uint8Array;\n        break;\n      case \"signed char\":\n      case \"int8\":\n      case \"int8_t\":\n        this.__array = Int8Array;\n        break;\n      case \"short\":\n      case \"short int\":\n      case \"signed short\":\n      case \"signed short int\":\n      case \"int16\":\n      case \"int16_t\":\n        this.__array = Int16Array;\n        break;\n      case \"ushort\":\n      case \"unsigned short\":\n      case \"unsigned short int\":\n      case \"uint16\":\n      case \"uint16_t\":\n        this.__array = Uint16Array;\n        break;\n      case \"int\":\n      case \"signed int\":\n      case \"int32\":\n      case \"int32_t\":\n        this.__array = Int32Array;\n        break;\n      case \"uint\":\n      case \"unsigned int\":\n      case \"uint32\":\n      case \"uint32_t\":\n        this.__array = Uint32Array;\n        break;\n      case \"float\":\n        this.__array = Float32Array;\n        break;\n      case \"double\":\n        this.__array = Float64Array;\n        break;\n      default:\n        throw new Error(\"Unsupported NRRD data type: \" + data);\n    }\n    return this.type = data;\n  },\n  endian: function(data) {\n    return this.endian = data;\n  },\n  encoding: function(data) {\n    return this.encoding = data;\n  },\n  dimension: function(data) {\n    return this.dim = parseInt(data, 10);\n  },\n  sizes: function(data) {\n    let i;\n    return this.sizes = function() {\n      const _ref = data.split(/\\s+/);\n      const _results = [];\n      for (let _i = 0, _len = _ref.length; _i < _len; _i++) {\n        i = _ref[_i];\n        _results.push(parseInt(i, 10));\n      }\n      return _results;\n    }();\n  },\n  space: function(data) {\n    return this.space = data;\n  },\n  \"space origin\": function(data) {\n    return this.space_origin = data.split(\"(\")[1].split(\")\")[0].split(\",\");\n  },\n  \"space directions\": function(data) {\n    let f, v;\n    const parts = data.match(/\\(.*?\\)/g);\n    return this.vectors = function() {\n      const _results = [];\n      for (let _i = 0, _len = parts.length; _i < _len; _i++) {\n        v = parts[_i];\n        _results.push(\n          function() {\n            const _ref = v.slice(1, -1).split(/,/);\n            const _results2 = [];\n            for (let _j = 0, _len2 = _ref.length; _j < _len2; _j++) {\n              f = _ref[_j];\n              _results2.push(parseFloat(f));\n            }\n            return _results2;\n          }()\n        );\n      }\n      return _results;\n    }();\n  },\n  spacings: function(data) {\n    let f;\n    const parts = data.split(/\\s+/);\n    return this.spacings = function() {\n      const _results = [];\n      for (let _i = 0, _len = parts.length; _i < _len; _i++) {\n        f = parts[_i];\n        _results.push(parseFloat(f));\n      }\n      return _results;\n    }();\n  }\n};\nexport {\n  NRRDLoader\n};\n"]},"metadata":{},"sourceType":"module"}
{"ast":null,"code":"'use strict';\n\nvar mailcomposer = require('mailcomposer');\n\nvar EventEmitter = require('events').EventEmitter;\n\nvar util = require('util');\n\nvar shared = require('nodemailer-shared');\n\nvar directTransport = require('nodemailer-direct-transport');\n\nvar smtpTransport = require('nodemailer-smtp-transport');\n\nvar smtpPoolTransport = require('nodemailer-smtp-pool');\n\nvar packageData = require('../package.json'); // Export createTransport method\n\n\nmodule.exports.createTransport = function (transporter, defaults) {\n  var urlConfig;\n  var options; // if no transporter configuration is provided use direct as default\n\n  transporter = transporter || directTransport({\n    debug: true\n  });\n\n  if ( // provided transporter is a configuration object, not transporter plugin\n  typeof transporter === 'object' && typeof transporter.send !== 'function' || typeof transporter === 'string' && /^(smtps?|direct):/i.test(transporter)) {\n    if (urlConfig = typeof transporter === 'string' ? transporter : transporter.url) {\n      // parse a configuration URL into configuration options\n      options = shared.parseConnectionUrl(urlConfig);\n    } else {\n      options = transporter;\n    }\n\n    if (options.direct) {\n      transporter = directTransport(options);\n    } else if (options.pool) {\n      transporter = smtpPoolTransport(options);\n    } else {\n      transporter = smtpTransport(options);\n    }\n  }\n\n  return new Nodemailer(transporter, defaults);\n};\n/**\n * Creates an object for exposing the Nodemailer API\n *\n * @constructor\n * @param {Object} transporter Transport object instance to pass the mails to\n */\n\n\nfunction Nodemailer(transporter, defaults) {\n  EventEmitter.call(this);\n  this._defaults = defaults || {};\n  this._plugins = {\n    compile: [],\n    stream: []\n  };\n  this.transporter = transporter;\n  this.logger = this.transporter.logger || shared.getLogger({\n    logger: false\n  });\n\n  if (typeof transporter.on === 'function') {\n    this.transporter.on('log', function (log) {\n      this.logger.debug('%s: %s', log.type, log.message);\n    }.bind(this));\n    this.transporter.on('error', function (err) {\n      this.logger.error('Transport Error: %s', err.message);\n      this.emit('error', err);\n    }.bind(this));\n  }\n}\n\nutil.inherits(Nodemailer, EventEmitter);\n\nNodemailer.prototype.use = function (step, plugin) {\n  step = (step || '').toString();\n\n  if (!this._plugins.hasOwnProperty(step)) {\n    this._plugins[step] = [plugin];\n  } else {\n    this._plugins[step].push(plugin);\n  }\n};\n/**\n * Optional close method, passed to the underlying transport object\n */\n\n\nNodemailer.prototype.close = function () {\n  var args = Array.prototype.slice.call(arguments);\n\n  if (typeof this.transporter.close === 'function') {\n    this.transporter.close.apply(this.transporter, args);\n  }\n};\n/**\n * Sends an email using the preselected transport object\n *\n * @param {Object} data E-data description\n * @param {Function} callback Callback to run once the sending succeeded or failed\n */\n\n\nNodemailer.prototype.sendMail = function (data, callback) {\n  var promise;\n\n  if (!callback && typeof Promise === 'function') {\n    promise = new Promise(function (resolve, reject) {\n      callback = shared.callbackPromise(resolve, reject);\n    });\n  }\n\n  data = data || {};\n  data.headers = data.headers || {};\n\n  callback = callback || function () {}; // apply defaults\n\n\n  Object.keys(this._defaults).forEach(function (key) {\n    if (!(key in data)) {\n      data[key] = this._defaults[key];\n    } else if (key === 'headers') {\n      // headers is a special case. Allow setting individual default headers\n      Object.keys(this._defaults.headers || {}).forEach(function (key) {\n        if (!(key in data.headers)) {\n          data.headers[key] = this._defaults.headers[key];\n        }\n      }.bind(this));\n    }\n  }.bind(this));\n  var mail = {\n    data: data,\n    message: null,\n    resolveContent: shared.resolveContent\n  };\n\n  if (typeof this.transporter === 'string') {\n    return callback(new Error('Unsupported configuration, downgrade Nodemailer to v0.7.1 to use it'));\n  }\n\n  this.logger.info('Sending mail using %s/%s', this.transporter.name, this.transporter.version);\n\n  this._processPlugins('compile', mail, function (err) {\n    if (err) {\n      this.logger.error('PluginCompile Error: %s', err.message);\n      return callback(err);\n    }\n\n    mail.message = mailcomposer(mail.data);\n\n    if (mail.data.xMailer !== false) {\n      mail.message.setHeader('X-Mailer', mail.data.xMailer || this._getVersionString());\n    }\n\n    if (mail.data.priority) {\n      switch ((mail.data.priority || '').toString().toLowerCase()) {\n        case 'high':\n          mail.message.setHeader('X-Priority', '1 (Highest)');\n          mail.message.setHeader('X-MSMail-Priority', 'High');\n          mail.message.setHeader('Importance', 'High');\n          break;\n\n        case 'low':\n          mail.message.setHeader('X-Priority', '5 (Lowest)');\n          mail.message.setHeader('X-MSMail-Priority', 'Low');\n          mail.message.setHeader('Importance', 'Low');\n          break;\n\n        default: // do not add anything, since all messages are 'Normal' by default\n\n      }\n    }\n\n    this._processPlugins('stream', mail, function (err) {\n      if (err) {\n        this.logger.error('PluginStream Error: %s', err.message);\n        return callback(err);\n      }\n\n      this.transporter.send(mail, function () {\n        var args = Array.prototype.slice.call(arguments);\n\n        if (args[0]) {\n          this.logger.error('Send Error: %s', args[0].message);\n        }\n\n        callback.apply(null, args);\n      }.bind(this));\n    }.bind(this));\n  }.bind(this));\n\n  return promise;\n};\n\nNodemailer.prototype._getVersionString = function () {\n  return util.format('%s (%s; +%s; %s/%s)', packageData.name, packageData.version, packageData.homepage, this.transporter.name, this.transporter.version);\n};\n\nNodemailer.prototype._processPlugins = function (step, mail, callback) {\n  step = (step || '').toString();\n\n  if (!this._plugins.hasOwnProperty(step) || !this._plugins[step].length) {\n    return callback(null);\n  }\n\n  var plugins = Array.prototype.slice.call(this._plugins[step]);\n  this.logger.debug('Using %s plugins for %s', plugins.length, step);\n\n  var processPlugins = function () {\n    if (!plugins.length) {\n      return callback(null);\n    }\n\n    var plugin = plugins.shift();\n    plugin(mail, function (err) {\n      if (err) {\n        return callback(err);\n      }\n\n      processPlugins();\n    });\n  }.bind(this);\n\n  processPlugins();\n};","map":{"version":3,"sources":["/Users/theodaguier/e-do/node_modules/nodemailer/lib/nodemailer.js"],"names":["mailcomposer","require","EventEmitter","util","shared","directTransport","smtpTransport","smtpPoolTransport","packageData","module","exports","createTransport","transporter","defaults","urlConfig","options","debug","send","test","url","parseConnectionUrl","direct","pool","Nodemailer","call","_defaults","_plugins","compile","stream","logger","getLogger","on","log","type","message","bind","err","error","emit","inherits","prototype","use","step","plugin","toString","hasOwnProperty","push","close","args","Array","slice","arguments","apply","sendMail","data","callback","promise","Promise","resolve","reject","callbackPromise","headers","Object","keys","forEach","key","mail","resolveContent","Error","info","name","version","_processPlugins","xMailer","setHeader","_getVersionString","priority","toLowerCase","format","homepage","length","plugins","processPlugins","shift"],"mappings":"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","sourcesContent":["'use strict';\n\nvar mailcomposer = require('mailcomposer');\nvar EventEmitter = require('events').EventEmitter;\nvar util = require('util');\nvar shared = require('nodemailer-shared');\nvar directTransport = require('nodemailer-direct-transport');\nvar smtpTransport = require('nodemailer-smtp-transport');\nvar smtpPoolTransport = require('nodemailer-smtp-pool');\nvar packageData = require('../package.json');\n\n// Export createTransport method\nmodule.exports.createTransport = function (transporter, defaults) {\n    var urlConfig;\n    var options;\n\n    // if no transporter configuration is provided use direct as default\n    transporter = transporter || directTransport({\n        debug: true\n    });\n\n    if (\n        // provided transporter is a configuration object, not transporter plugin\n        (typeof transporter === 'object' && typeof transporter.send !== 'function') ||\n        // provided transporter looks like a connection url\n        (typeof transporter === 'string' && /^(smtps?|direct):/i.test(transporter))\n    ) {\n\n        if ((urlConfig = typeof transporter === 'string' ? transporter : transporter.url)) {\n            // parse a configuration URL into configuration options\n            options = shared.parseConnectionUrl(urlConfig);\n        } else {\n            options = transporter;\n        }\n\n        if (options.direct) {\n            transporter = directTransport(options);\n        } else if (options.pool) {\n            transporter = smtpPoolTransport(options);\n        } else {\n            transporter = smtpTransport(options);\n        }\n    }\n\n    return new Nodemailer(transporter, defaults);\n};\n\n/**\n * Creates an object for exposing the Nodemailer API\n *\n * @constructor\n * @param {Object} transporter Transport object instance to pass the mails to\n */\nfunction Nodemailer(transporter, defaults) {\n    EventEmitter.call(this);\n\n    this._defaults = defaults || {};\n\n    this._plugins = {\n        compile: [],\n        stream: []\n    };\n\n    this.transporter = transporter;\n    this.logger = this.transporter.logger || shared.getLogger({\n        logger: false\n    });\n\n    if (typeof transporter.on === 'function') {\n        this.transporter.on('log', function (log) {\n            this.logger.debug('%s: %s', log.type, log.message);\n        }.bind(this));\n        this.transporter.on('error', function (err) {\n            this.logger.error('Transport Error: %s', err.message);\n            this.emit('error', err);\n        }.bind(this));\n    }\n}\nutil.inherits(Nodemailer, EventEmitter);\n\nNodemailer.prototype.use = function (step, plugin) {\n    step = (step || '').toString();\n    if (!this._plugins.hasOwnProperty(step)) {\n        this._plugins[step] = [plugin];\n    } else {\n        this._plugins[step].push(plugin);\n    }\n};\n\n/**\n * Optional close method, passed to the underlying transport object\n */\nNodemailer.prototype.close = function ( /* possible arguments */ ) {\n    var args = Array.prototype.slice.call(arguments);\n    if (typeof this.transporter.close === 'function') {\n        this.transporter.close.apply(this.transporter, args);\n    }\n};\n\n/**\n * Sends an email using the preselected transport object\n *\n * @param {Object} data E-data description\n * @param {Function} callback Callback to run once the sending succeeded or failed\n */\nNodemailer.prototype.sendMail = function (data, callback) {\n    var promise;\n\n    if (!callback && typeof Promise === 'function') {\n        promise = new Promise(function (resolve, reject) {\n            callback = shared.callbackPromise(resolve, reject);\n        });\n    }\n\n    data = data || {};\n    data.headers = data.headers || {};\n    callback = callback || function () {};\n\n    // apply defaults\n    Object.keys(this._defaults).forEach(function (key) {\n        if (!(key in data)) {\n            data[key] = this._defaults[key];\n        } else if (key === 'headers') {\n            // headers is a special case. Allow setting individual default headers\n            Object.keys(this._defaults.headers || {}).forEach(function (key) {\n                if (!(key in data.headers)) {\n                    data.headers[key] = this._defaults.headers[key];\n                }\n            }.bind(this));\n        }\n    }.bind(this));\n\n    var mail = {\n        data: data,\n        message: null,\n        resolveContent: shared.resolveContent\n    };\n\n    if (typeof this.transporter === 'string') {\n        return callback(new Error('Unsupported configuration, downgrade Nodemailer to v0.7.1 to use it'));\n    }\n\n    this.logger.info('Sending mail using %s/%s', this.transporter.name, this.transporter.version);\n\n    this._processPlugins('compile', mail, function (err) {\n        if (err) {\n            this.logger.error('PluginCompile Error: %s', err.message);\n            return callback(err);\n        }\n\n        mail.message = mailcomposer(mail.data);\n\n        if (mail.data.xMailer !== false) {\n            mail.message.setHeader('X-Mailer', mail.data.xMailer || this._getVersionString());\n        }\n\n        if (mail.data.priority) {\n            switch ((mail.data.priority || '').toString().toLowerCase()) {\n                case 'high':\n                    mail.message.setHeader('X-Priority', '1 (Highest)');\n                    mail.message.setHeader('X-MSMail-Priority', 'High');\n                    mail.message.setHeader('Importance', 'High');\n                    break;\n                case 'low':\n                    mail.message.setHeader('X-Priority', '5 (Lowest)');\n                    mail.message.setHeader('X-MSMail-Priority', 'Low');\n                    mail.message.setHeader('Importance', 'Low');\n                    break;\n                default:\n                    // do not add anything, since all messages are 'Normal' by default\n            }\n        }\n\n        this._processPlugins('stream', mail, function (err) {\n            if (err) {\n                this.logger.error('PluginStream Error: %s', err.message);\n                return callback(err);\n            }\n\n            this.transporter.send(mail, function () {\n                var args = Array.prototype.slice.call(arguments);\n                if (args[0]) {\n                    this.logger.error('Send Error: %s', args[0].message);\n                }\n                callback.apply(null, args);\n            }.bind(this));\n        }.bind(this));\n    }.bind(this));\n\n    return promise;\n};\n\nNodemailer.prototype._getVersionString = function () {\n    return util.format(\n        '%s (%s; +%s; %s/%s)',\n        packageData.name,\n        packageData.version,\n        packageData.homepage,\n        this.transporter.name,\n        this.transporter.version\n    );\n};\n\nNodemailer.prototype._processPlugins = function (step, mail, callback) {\n    step = (step || '').toString();\n\n    if (!this._plugins.hasOwnProperty(step) || !this._plugins[step].length) {\n        return callback(null);\n    }\n\n    var plugins = Array.prototype.slice.call(this._plugins[step]);\n\n    this.logger.debug('Using %s plugins for %s', plugins.length, step);\n\n    var processPlugins = function () {\n        if (!plugins.length) {\n            return callback(null);\n        }\n        var plugin = plugins.shift();\n        plugin(mail, function (err) {\n            if (err) {\n                return callback(err);\n            }\n            processPlugins();\n        });\n    }.bind(this);\n\n    processPlugins();\n};\n"]},"metadata":{},"sourceType":"script"}
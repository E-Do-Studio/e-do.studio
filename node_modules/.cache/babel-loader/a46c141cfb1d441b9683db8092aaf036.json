{"ast":null,"code":"import _classCallCheck from \"/Users/theodaguier/_dev/pro/e-do/website/old/E-Do-Studio/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/theodaguier/_dev/pro/e-do/website/old/E-Do-Studio/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nvar __defProp = Object.defineProperty;\n\nvar __defNormalProp = function __defNormalProp(obj, key, value) {\n  return key in obj ? __defProp(obj, key, {\n    enumerable: true,\n    configurable: true,\n    writable: true,\n    value: value\n  }) : obj[key] = value;\n};\n\nvar __publicField = function __publicField(obj, key, value) {\n  __defNormalProp(obj, typeof key !== \"symbol\" ? key + \"\" : key, value);\n\n  return value;\n};\n\nimport { Vector3, Quaternion, Matrix4 } from \"three\";\nimport { CharsetEncoder } from \"mmd-parser\";\n\nvar MMDExporter = /*#__PURE__*/function () {\n  function MMDExporter() {\n    _classCallCheck(this, MMDExporter);\n\n    // Unicode to Shift_JIS table\n    __publicField(this, \"u2sTable\");\n  }\n  /* TODO: implement\n  // mesh -> pmd\n  this.parsePmd = function ( object ) {\n  };\n  */\n\n  /* TODO: implement\n  // mesh -> pmx\n  this.parsePmx = function ( object ) {\n  };\n  */\n\n  /* TODO: implement\n  // animation + skeleton -> vmd\n  this.parseVmd = function ( object ) {\n  };\n  */\n\n  /*\n   * skeleton -> vpd\n   * Returns Shift_JIS encoded Uint8Array. Otherwise return strings.\n   */\n\n\n  _createClass(MMDExporter, [{\n    key: \"parseVpd\",\n    value: function parseVpd(skin, outputShiftJis, useOriginalBones) {\n      if (skin.isSkinnedMesh !== true) {\n        console.warn(\"THREE.MMDExporter: parseVpd() requires SkinnedMesh instance.\");\n        return null;\n      }\n\n      function toStringsFromNumber(num) {\n        if (Math.abs(num) < 1e-6) num = 0;\n        var a = num.toString();\n\n        if (a.indexOf(\".\") === -1) {\n          a += \".\";\n        }\n\n        a += \"000000\";\n        var index = a.indexOf(\".\");\n        var d = a.slice(0, index);\n        var p = a.slice(index + 1, index + 7);\n        return d + \".\" + p;\n      }\n\n      function toStringsFromArray(array2) {\n        var a = [];\n\n        for (var i = 0, il = array2.length; i < il; i++) {\n          a.push(toStringsFromNumber(array2[i]));\n        }\n\n        return a.join(\",\");\n      }\n\n      skin.updateMatrixWorld(true);\n      var bones = skin.skeleton.bones;\n      var bones2 = this.getBindBones(skin);\n      var position = new Vector3();\n      var quaternion = new Quaternion();\n      var quaternion2 = new Quaternion();\n      var matrix = new Matrix4();\n      var array = [];\n      array.push(\"Vocaloid Pose Data file\");\n      array.push(\"\");\n      array.push((skin.name !== \"\" ? skin.name.replace(/\\s/g, \"_\") : \"skin\") + \".osm;\");\n      array.push(bones.length + \";\");\n      array.push(\"\");\n\n      for (var i = 0, il = bones.length; i < il; i++) {\n        var bone = bones[i];\n        var bone2 = bones2[i];\n\n        if (useOriginalBones === true && bone.userData.ik !== void 0 && bone.userData.ik.originalMatrix !== void 0) {\n          matrix.fromArray(bone.userData.ik.originalMatrix);\n        } else {\n          matrix.copy(bone.matrix);\n        }\n\n        position.setFromMatrixPosition(matrix);\n        quaternion.setFromRotationMatrix(matrix);\n        var pArray = position.sub(bone2.position).toArray();\n        var qArray = quaternion2.copy(bone2.quaternion).conjugate().multiply(quaternion).toArray();\n        pArray[2] = -pArray[2];\n        qArray[0] = -qArray[0];\n        qArray[1] = -qArray[1];\n        array.push(\"Bone\" + i + \"{\" + bone.name);\n        array.push(\"  \" + toStringsFromArray(pArray) + \";\");\n        array.push(\"  \" + toStringsFromArray(qArray) + \";\");\n        array.push(\"}\");\n        array.push(\"\");\n      }\n\n      array.push(\"\");\n      var lines = array.join(\"\\n\");\n      return outputShiftJis === true ? this.unicodeToShiftjis(lines) : lines;\n    }\n  }, {\n    key: \"unicodeToShiftjis\",\n    value: function unicodeToShiftjis(str) {\n      if (this.u2sTable === void 0) {\n        var encoder = new CharsetEncoder();\n        var table = encoder.s2uTable;\n        this.u2sTable = {};\n        var keys = Object.keys(table);\n\n        for (var i = 0, il = keys.length; i < il; i++) {\n          var key = keys[i];\n          var value = table[key];\n          this.u2sTable[value] = parseInt(key);\n        }\n      }\n\n      var array = [];\n\n      for (var _i = 0, _il = str.length; _i < _il; _i++) {\n        var code = str.charCodeAt(_i);\n        var _value = this.u2sTable[code];\n\n        if (_value === void 0) {\n          throw \"cannot convert charcode 0x\" + code.toString(16);\n        } else if (_value > 255) {\n          array.push(_value >> 8 & 255);\n          array.push(_value & 255);\n        } else {\n          array.push(_value & 255);\n        }\n      }\n\n      return new Uint8Array(array);\n    }\n  }, {\n    key: \"getBindBones\",\n    value: function getBindBones(skin) {\n      var poseSkin = skin.clone();\n      poseSkin.pose();\n      return poseSkin.skeleton.bones;\n    }\n  }]);\n\n  return MMDExporter;\n}();\n\nexport { MMDExporter };","map":{"version":3,"sources":["/Users/theodaguier/_dev/pro/e-do/website/old/E-Do-Studio/node_modules/three-stdlib/exporters/MMDExporter.js"],"names":["__defProp","Object","defineProperty","__defNormalProp","obj","key","value","enumerable","configurable","writable","__publicField","Vector3","Quaternion","Matrix4","CharsetEncoder","MMDExporter","skin","outputShiftJis","useOriginalBones","isSkinnedMesh","console","warn","toStringsFromNumber","num","Math","abs","a","toString","indexOf","index","d","slice","p","toStringsFromArray","array2","i","il","length","push","join","updateMatrixWorld","bones","skeleton","bones2","getBindBones","position","quaternion","quaternion2","matrix","array","name","replace","bone","bone2","userData","ik","originalMatrix","fromArray","copy","setFromMatrixPosition","setFromRotationMatrix","pArray","sub","toArray","qArray","conjugate","multiply","lines","unicodeToShiftjis","str","u2sTable","encoder","table","s2uTable","keys","parseInt","code","charCodeAt","Uint8Array","poseSkin","clone","pose"],"mappings":"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","sourcesContent":["var __defProp = Object.defineProperty;\nvar __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;\nvar __publicField = (obj, key, value) => {\n  __defNormalProp(obj, typeof key !== \"symbol\" ? key + \"\" : key, value);\n  return value;\n};\nimport { Vector3, Quaternion, Matrix4 } from \"three\";\nimport { CharsetEncoder } from \"mmd-parser\";\nclass MMDExporter {\n  constructor() {\n    // Unicode to Shift_JIS table\n    __publicField(this, \"u2sTable\");\n  }\n  /* TODO: implement\n  // mesh -> pmd\n  this.parsePmd = function ( object ) {\n  };\n  */\n  /* TODO: implement\n  // mesh -> pmx\n  this.parsePmx = function ( object ) {\n  };\n  */\n  /* TODO: implement\n  // animation + skeleton -> vmd\n  this.parseVmd = function ( object ) {\n  };\n  */\n  /*\n   * skeleton -> vpd\n   * Returns Shift_JIS encoded Uint8Array. Otherwise return strings.\n   */\n  parseVpd(skin, outputShiftJis, useOriginalBones) {\n    if (skin.isSkinnedMesh !== true) {\n      console.warn(\"THREE.MMDExporter: parseVpd() requires SkinnedMesh instance.\");\n      return null;\n    }\n    function toStringsFromNumber(num) {\n      if (Math.abs(num) < 1e-6)\n        num = 0;\n      let a = num.toString();\n      if (a.indexOf(\".\") === -1) {\n        a += \".\";\n      }\n      a += \"000000\";\n      const index = a.indexOf(\".\");\n      const d = a.slice(0, index);\n      const p = a.slice(index + 1, index + 7);\n      return d + \".\" + p;\n    }\n    function toStringsFromArray(array2) {\n      const a = [];\n      for (let i = 0, il = array2.length; i < il; i++) {\n        a.push(toStringsFromNumber(array2[i]));\n      }\n      return a.join(\",\");\n    }\n    skin.updateMatrixWorld(true);\n    const bones = skin.skeleton.bones;\n    const bones2 = this.getBindBones(skin);\n    const position = new Vector3();\n    const quaternion = new Quaternion();\n    const quaternion2 = new Quaternion();\n    const matrix = new Matrix4();\n    const array = [];\n    array.push(\"Vocaloid Pose Data file\");\n    array.push(\"\");\n    array.push((skin.name !== \"\" ? skin.name.replace(/\\s/g, \"_\") : \"skin\") + \".osm;\");\n    array.push(bones.length + \";\");\n    array.push(\"\");\n    for (let i = 0, il = bones.length; i < il; i++) {\n      const bone = bones[i];\n      const bone2 = bones2[i];\n      if (useOriginalBones === true && bone.userData.ik !== void 0 && bone.userData.ik.originalMatrix !== void 0) {\n        matrix.fromArray(bone.userData.ik.originalMatrix);\n      } else {\n        matrix.copy(bone.matrix);\n      }\n      position.setFromMatrixPosition(matrix);\n      quaternion.setFromRotationMatrix(matrix);\n      const pArray = position.sub(bone2.position).toArray();\n      const qArray = quaternion2.copy(bone2.quaternion).conjugate().multiply(quaternion).toArray();\n      pArray[2] = -pArray[2];\n      qArray[0] = -qArray[0];\n      qArray[1] = -qArray[1];\n      array.push(\"Bone\" + i + \"{\" + bone.name);\n      array.push(\"  \" + toStringsFromArray(pArray) + \";\");\n      array.push(\"  \" + toStringsFromArray(qArray) + \";\");\n      array.push(\"}\");\n      array.push(\"\");\n    }\n    array.push(\"\");\n    const lines = array.join(\"\\n\");\n    return outputShiftJis === true ? this.unicodeToShiftjis(lines) : lines;\n  }\n  unicodeToShiftjis(str) {\n    if (this.u2sTable === void 0) {\n      const encoder = new CharsetEncoder();\n      const table = encoder.s2uTable;\n      this.u2sTable = {};\n      const keys = Object.keys(table);\n      for (let i = 0, il = keys.length; i < il; i++) {\n        let key = keys[i];\n        const value = table[key];\n        this.u2sTable[value] = parseInt(key);\n      }\n    }\n    const array = [];\n    for (let i = 0, il = str.length; i < il; i++) {\n      const code = str.charCodeAt(i);\n      const value = this.u2sTable[code];\n      if (value === void 0) {\n        throw \"cannot convert charcode 0x\" + code.toString(16);\n      } else if (value > 255) {\n        array.push(value >> 8 & 255);\n        array.push(value & 255);\n      } else {\n        array.push(value & 255);\n      }\n    }\n    return new Uint8Array(array);\n  }\n  getBindBones(skin) {\n    const poseSkin = skin.clone();\n    poseSkin.pose();\n    return poseSkin.skeleton.bones;\n  }\n}\nexport {\n  MMDExporter\n};\n"]},"metadata":{},"sourceType":"module"}